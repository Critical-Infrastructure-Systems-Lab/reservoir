---
title: 'Chapter 2: Water supply reservoir simulation basics'
author: ''
date: ''
output:
  rmarkdown::html_document:
    highlight: default
    theme: journal
  rmarkdown::pdf_document: null
subtitle: Manual for R package `reservoir`
---

### *In this chapter:*

* *Simulate a simple water supply reservoir*

* *Estimate the vital reservoir statistics*

## The `simRes` funcion

Recall from Chapter 1 the simple mass balance relationship used to model reservoirs:

$S_{t+1} = S_{t} + Q_{t} - R_{t} - L_{t}$

_subject to:_

$0 \le R_{t} \le \min(S_{t} + Q_{t} - L_{t}, R_{max})$

$0 \le S_{t} \le S_{max}$


For the most basic case, we can assume a constant target release of water from the reservoir. This means the objective of the reservoir is to provide that release at all times (for example, a reservoir supplying water for a city). Note that the term release will be used interchangably with "target" or "demand". If we also assume no losses from the reservoir (i.e., no evaporation or seepage), then all we need to start simulating the reservoir are the inflow time series, the target release, and the :

```{r}
library(reservoir)      # load reservoir
inflow <- resX$Q_Mm3    # reservoir inflow time series
target <- 150           # target release = 150 million cubic metres / month
capacity <- 1800        # reservoir capacity = 1000 million cubic metres (1 years' demand)
```


> __Important:__ `reservoir` will attemp the meet the target release on each period of simuation. The simulation time step is driven by the input inflow time series, which in this case is _monthly_ (you can check this by entering `frequency(inflow)` into the console). So if we have a release target of 100, `reservoir` will attempt the release 100 units of flow each month.


The simulation is executed in `reservoir` using the `simRes` function:

```{r}
# simulate reservoir with output to x, and plotting suppressed
x <- simRes(inflow, target, capacity, plot = F)

# summarise simulation result
summary(x)
```

The simulation produces five output time series: `storage` (the reservoir storage behavior), `releases` (the releases from the reservoir), spill (the water spilled from the reservoir when full), `evaporation`, and `water level`.

Let's intepret the results:

```{r}
plot(x$releases, ylab = "Controlled release (million m3)")
```

Recall that the target release is 150 million cubic metres. This means that the reservoir should provide a constant release of 150 Mm3 at all times. But sometimes fails to meet this target. We can see why this happens if we look at storage:

```{r}
plot(x$storage, ylab = "Reservoir storage level (million m3)")
```

The storage volume fluctuates wildly between full capacity and empty over the simulation period. When the storage becomes empty, there's a risk that the release will not be met in full. If the inflow is low and there is no water in storage, then there's simply not enough water to meet the target. In this particular simulation, the operating mode is _Standard Operating Policy (SOP)_---always release as much of the target as possible given the water available in storage and inflow. `resSim` can operate with optimized and user-defined release rules (covered in chapter 5), but unless otherwise specified, the simulation will assume SOP.


> __Standard Operating Policy__ is commonly used in reservoir analysis because (1) it's a very simple operating rule, and (2) it's conservative for reservoir design. `reservoir` assumes SOP as the default for all simulation and analysis functions.


Notice that the reservoir is assumed full at the start of the simulation. This assumption can be problematic when analyzing the performance of the reservoir (next section), because the performance statistics can be sensitive to this arbitrary initial storage level. In `reservoir` there are a couple of ways to deal with this problem. You may _double cycle_ the simulation, which means that the inflow sequence is simply replicated, placed end-to-end, and simulated through the storage. As the simulation approaches the second round of inflows, a new starting storage equal to the end of simulation storage will be read (note taht there are other advantages to using a _double cycle_, discussed in Chapter 3). The _double cycle_ is initiated by setting the `double_cycle` parameter to `TRUE`. You may also simply change the initial storage assumption by setting the `S_inital` parameter.

```{r}
# run simulation with initial storage of 0
x1 <- simRes(inflow, target, capacity, S_initial = 0, plot = F)
plot(x1$storage)

# run same simulation with a double cycle
x2 <- simRes(inflow, target, capacity, S_initial = 0, double_cycle = T, plot = F)
plot(x2$storage)
```


The reservoir spills over available space in storage is insufficient to hold incoming flow:

```{r}
plot(x$storage, ylab = "Reservoir storage level (million m3)")
```

The two other outputs of `simRes` are the evaporation and the water level. In the above example these outputs are empty, because we did not specify any evaporation or reservoir shape details. In `reservoir`, evaporation is specified as a lenth unit (e.g., metres), which is multiplied by the reservoir surface area to compute volume of water loss. Since a reservoir's surface water area will change depending on storage level (reservoirs are not cuboid shaped), we also need to provide some information on reservoir shape. This can be done by specifying surface area only, or by specifying both surface area and depth (the latter will result in a more realistic shape assumption). Currently, `reservoir` does not allow for you to specifiy your own bathymetry, but instead relies on pre-programmed storage-depth-area functions for a typical reservoir shapes.

```{r}

e <- 0.2           # evaporation = 0.2 m
a <- resX$A_km2    # surface area = 4.1 km2

```


> __Important__: when using evaporation it is imperatibe that you use the recommended units given in the `reservoir` documentation (i.e.,  the units specified in the function help when you enter, e.g., `?simRes`). `reservoir` is set up to use metric units: specifically, volumes (storage, release, inflow) in million m3, surface area in km2, and evaporation in m (or kg/m2 * 10 ^ 3).












